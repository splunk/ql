<!-- Reporting -->
<form version="1.1" script="access_enable_disable.js">
  <search>
    <query>
      | rest /services/authorization/roles splunk_server=local f=imported_roles f=title | fields title imported_roles | rename imported_roles AS imported | fillnull value=NIL imported
| mvexpand imported | appendpipe [where imported!="NIL" | eval all_imported=imported,imported=title,title=null()] | eventstats values(all_imported) as all_imported by imported | stats values(imported*) as imported* by title | eval imported=mvdedup(mvappend(imported,all_imported)) | fields title | search title="*admin" OR title="*splunk_app_soar" OR title="*splunk_app_soar_dashboards"
    </query>
    <done>
      <condition match="$job.resultCount$>0">
        <set token="access">true</set>
        <set token="displayContent">true</set>
        <unset token="displayError">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="access">false</set>
        <unset token="displayContent">false</unset>
        <set token="displayError">true</set>
      </condition>
    </done>
  </search>
    <search>
    <query>
      | rest /services/server/info/server-info | eval type=if(isnotnull(instance_type), instance_type, "enterprise") | search type=cloud
    </query>
     <done>
      <condition match="$job.resultCount$>0">
        <set token="cloud">true</set>
        <unset token="enterprise">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="enterprise">true</set>
        <unset token="cloud">false</unset>
      </condition>
    </done>
  </search>
  <label>Action Run Search</label>
  <fieldset submitButton="false">
    <input type="time" token="field1">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="index_prefix" searchWhenChanged="true">
      <label>Index Prefix</label>
      <choice value="*phantom_">All</choice>
      <default>All</default>
      <fieldForLabel>index_prefix_label</fieldForLabel>
      <fieldForValue>index_prefix</fieldForValue>
      <search depends="$displayContent$" base="base_index_prefix">
        <query>| eval index_prefix_label=index_prefix."*" | stats count by index_prefix_label, index_prefix | sort -count</query>
      </search>
    </input>
    <input type="dropdown" token="user_id_name">
      <label>User ID (Username)</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>user_id_name</fieldForLabel>
      <fieldForValue>user_id_name</fieldForValue>
      <search depends="$displayContent$" base="actionRunBaseSearch">
        <query>| stats count by user_id_name </query>
      </search>
    </input>
    <input type="checkbox" token="status">
      <label>Status</label>
      <choice value="success">Successful</choice>
      <choice value="failed">Failed</choice>
      <choice value="running">Running</choice>
      <valuePrefix>status="</valuePrefix>
      <default>success,failed,running</default>
      <prefix>(</prefix>
      <suffix>)</suffix>
      <delimiter> OR </delimiter>
      <valueSuffix>"</valueSuffix>
      <initialValue>success,failed,running</initialValue>
    </input>
    <input type="text" token="playbook_run">
      <label>Playbook Run ID</label>
      <default>*</default>
    </input>
  </fieldset>
  <search id="base_index_prefix" depends="$displayContent$">
    <query>index=*phantom_action_run sourcetype=phantom_search | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)(action_run)$" | fields * </query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <search id="actionRunBaseSearch" base="base_index_prefix" depends="$displayContent$">
     <query>
      | search index=$index_prefix$action_run | dedup index id  | rename id as action_run_id owner as user_id | table * | join type=left user_id index_prefix
          [ search index=$index_prefix$container
          | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)container$"
          | dedup index owner | table index index_prefix owner owner_name
          | rename owner as user_id owner_name as username]
      | eval user_id_name = case(user_id=="null", "None (unassigned)", isnull(username), user_id, isnotnull(username), user_id." (".username.")")
      | search user_id_name="$user_id_name$" playbook_run=$playbook_run$ $status$
      | eval start = strptime(create_time,"%Y-%m-%dT%H:%M:%S.%6Q")
      | eval end = strptime(close_time,"%Y-%m-%dT%H:%M:%S.%6Q")
      | eval duration=round(end -start,2) 
      | eval index_prefix = index_prefix."*"
    </query>
  </search>
  <row depends="$displayError$,$cloud$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or sc_admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <row depends="$displayError$,$enterprise$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Automation Timechart</title>
      <chart>
        <search  base="actionRunBaseSearch">
          <query>| timechart count eval(round(avg(duration),2)) as execution_time_sec</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.axisTitleY2.text">Execution Time (secs)</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">1</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">execution_time_sec</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Action Run Table</title>
      <table>
        <search base="actionRunBaseSearch">
          <query>
          | table _time index index_prefix action_run_id playbook_run container container_label action duration status user_id_name playbook_run
          | rename index as "Index" action as "Action" status as "Status" action_run_id as "Action Run ID" duration as "Execution Time (sec)" playbook_run as "Playbook Run ID" container as "Container ID" container_label as "Container Label" user_id_name as "User ID (Username)" index_prefix as "Index Prefix" </query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>
