<!-- Reporting -->
<form version="1.1" script="access_enable_disable.js">
  <search>
    <query>
      | rest /services/authorization/roles splunk_server=local f=imported_roles f=title | fields title imported_roles | rename imported_roles AS imported | fillnull value=NIL imported
| mvexpand imported | appendpipe [where imported!="NIL" | eval all_imported=imported,imported=title,title=null()] | eventstats values(all_imported) as all_imported by imported | stats values(imported*) as imported* by title | eval imported=mvdedup(mvappend(imported,all_imported)) | fields title | search title="*admin" OR title="*splunk_app_soar" OR title="*splunk_app_soar_dashboards"
    </query>
    <done>
      <condition match="$job.resultCount$>0">
        <set token="access">true</set>
        <set token="displayContent">true</set>
        <unset token="displayError">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="access">false</set>
        <unset token="displayContent">false</unset>
        <set token="displayError">true</set>
      </condition>
    </done>
  </search>
  <search>
    <query>
      | rest /services/server/info/server-info | eval type=if(isnotnull(instance_type), instance_type, "enterprise") | search type=cloud
    </query>
     <done>
      <condition match="$job.resultCount$>0">
        <set token="cloud">true</set>
        <unset token="enterprise">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="enterprise">true</set>
        <unset token="cloud">false</unset>
      </condition>
    </done>
  </search>
  <label>SOAR Container Insights</label>
  <fieldset submitButton="false">
    <input type="time" token="field1" searchWhenChanged="true">
      <label></label>
      <default>
        <earliest>-7d@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="index_prefix">
      <label>Index Prefix</label>
      <fieldForLabel>index_prefix_label</fieldForLabel>
      <fieldForValue>index_prefix</fieldForValue>
      <selectFirstChoice>true</selectFirstChoice>
      <search depends="$displayContent$" base="base_index_prefix">
        <query>| eval index_prefix_label=index_prefix."*"  | stats count by index_prefix_label, index_prefix | sort -count</query>
      </search>
    </input>
    <input type="text" token="case">
      <label>Container ID (REQUIRED)</label>
      <default></default>
    </input>
  </fieldset>
  <row depends="$displayError$,$cloud$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or sc_admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <row depends="$displayError$,$enterprise$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <search id="base_index_prefix" depends="$displayContent$">
    <query>(index=*phantom_container OR index=*phantom_note) sourcetype=phantom_search | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)(container|note)$" | fields * </query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <search id="base_container_case" base="base_index_prefix" depends="$displayContent$">
    <query>
      | search index=$index_prefix$container | dedup id | search id="$case$" | table status, id, close_time, start_time, owner_name
    </query>
  </search>
  <search id="base_note" base="base_index_prefix" depends="$displayContent$">
    <query>
      | search index=$index_prefix$note container="$case$" | table note_type, content, create_time, container, author, container_label, title
    </query>
  </search>

  <row depends="$displayContent$">
    <panel>
      <title>Current Status</title>
      <single>
        <search base="base_container_case">
          <query>| table status | head 1</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Duration</title>
      <single>
        <search base="base_container_case">
          <query>
            | dedup id
            | eval tnow=now()
            | strcat start_time "+0000" start_utc
            | strcat close_time "+0000" end_utc
            | eval end = if (close_time="null", tnow, strptime(end_utc,"%Y-%m-%dT%H:%M:%S"))
            | eval start = strptime(start_utc,"%Y-%m-%dT%H:%M:%S.%6QZ%z")
            | eval duration= end-start
            | eval field_in_hhmmss=tostring(duration, "duration")
            | rex field=field_in_hhmmss "(?&lt;d&gt;[^\.]+)\.[0-9]+"
            | table d
          </query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="underLabel">DD+HH:MM:SS</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>Last Owner</title>
      <single>
        <search base="base_container_case">
          <query>| eval username=if(owner_name=="null", "unassigned", owner_name) | table username | head 1</query>
        </search>
        <option name="colorBy">value</option>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x53a051","0x0877a6","0xf8be34","0xf1813f","0xdc4e41"]</option>
        <option name="rangeValues">[0,30,70,100]</option>
        <option name="refresh.display">progressbar</option>
        <option name="showSparkline">1</option>
        <option name="showTrendIndicator">1</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
        <option name="trendColorInterpretation">standard</option>
        <option name="trendDisplayMode">absolute</option>
        <option name="unitPosition">after</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Action Run</title>
      <table>
        <search>
          <query>
            index=$index_prefix$action_run | dedup id | search container="$case$" | spath path="targets{}.parameters{}."
            | rename "targets{}.parameters{}."* as "parameters"* | table create_time action name message type status parameters
            | rename create_time as "Create Time" action as "Action" name as "Action Name" message as "Message" type as "Action Type" status as "Status" parameters as "Parameters"         </query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
          <refresh>30s</refresh>
          <sampleRatio>1</sampleRatio>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Container Notes</title>
      <table>
        <search base="base_note">
          <query>
            search note_type=general | rex field=content "&lt;p&gt;(?&lt;content&gt;.*)&lt;/p&gt;" | table create_time container container_label title content
            | rename create_time as "Create Time" container as "Container ID" container_label as "Container Label" title as "Title" content as "Content"
          </query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Task Notes</title>
      <table>
        <search base="base_note">
          <query>
            search note_type=task | table create_time title content
            | rename create_time as "Create Time" title as "Title" content as "Content"
          </query>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">none</option>
        <option name="percentagesRow">false</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>
</form>
