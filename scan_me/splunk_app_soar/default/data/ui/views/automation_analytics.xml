<!-- Reporting -->
<form version="1.1" script="access_enable_disable.js">
  <search>
    <query>
      | rest /services/authorization/roles splunk_server=local f=imported_roles f=title | fields title imported_roles | rename imported_roles AS imported | fillnull value=NIL imported
| mvexpand imported | appendpipe [where imported!="NIL" | eval all_imported=imported,imported=title,title=null()] | eventstats values(all_imported) as all_imported by imported | stats values(imported*) as imported* by title | eval imported=mvdedup(mvappend(imported,all_imported)) | fields title | search title="*admin" OR title="*splunk_app_soar" OR title="*splunk_app_soar_dashboards"
    </query>
    <done>
      <condition match="$job.resultCount$>0">
        <set token="access">true</set>
        <set token="displayContent">true</set>
        <unset token="displayError">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="access">false</set>
        <unset token="displayContent">false</unset>
        <set token="displayError">true</set>
      </condition>
    </done>
  </search>
  <search>
    <query>
      | rest /services/server/info/server-info | eval type=if(isnotnull(instance_type), instance_type, "enterprise") | search type=cloud
    </query>
     <done>
      <condition match="$job.resultCount$>0">
        <set token="cloud">true</set>
        <unset token="enterprise">false</unset>
      </condition>
      <condition match="$job.resultCount$==0">
        <set token="enterprise">true</set>
        <unset token="cloud">false</unset>
      </condition>
    </done>
  </search>
  <label>Automation Analytics</label>
  <fieldset submitButton="false">
    <input type="time" token="field1">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="index_prefix" searchWhenChanged="true">
      <label>Index Prefix</label>
      <choice value="*phantom_">All</choice>
      <default>All</default>
      <fieldForLabel>index_prefix_label</fieldForLabel>
      <fieldForValue>index_prefix</fieldForValue>
      <search depends="$displayContent$" base="base_index_prefix">
        <query>| eval index_prefix_label=index_prefix."*" | stats count by index_prefix_label, index_prefix | sort -count</query>
      </search>
    </input>
    <input type="dropdown" token="user_id_name">
      <label>User ID (Username)</label>
      <choice value="*">All</choice>
      <default>*</default>
      <fieldForLabel>user_id_name</fieldForLabel>
      <fieldForValue>user_id_name</fieldForValue>
      <search depends="$displayContent$" base="actionRunBaseSearch">
        <query>| stats count by user_id_name </query>
      </search>
    </input>
  </fieldset>
  <search id="base_index_prefix" depends="$displayContent$">
    <query>(index=*phantom_action_run OR index=*phantom_app_run) sourcetype=phantom_search | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)(action_run|app_run)$" | fields * </query>
    <earliest>$field1.earliest$</earliest>
    <latest>$field1.latest$</latest>
    <sampleRatio>1</sampleRatio>
  </search>
  <search id="actionRunBaseSearch" base="base_index_prefix" depends="$displayContent$">
     <query>
      | search index=$index_prefix$action_run (status=failed OR status=success) | dedup index id  | rename id as action_run_id owner as user_id | table * | join type=left user_id index_prefix
          [ search index=$index_prefix$container
          | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)container$"
          | dedup index owner | table index index_prefix owner owner_name
          | rename owner as user_id owner_name as username]
      | eval user_id_name = case(user_id=="null", "None (unassigned)", isnull(username), user_id, isnotnull(username), user_id." (".username.")")
    </query>
  </search>
  <search id="appRunBaseSearch" base="base_index_prefix" depends="$displayContent$">
    <query>
      | search index=$index_prefix$app_run status=failed | dedup index id  | rename effective_user as user_id | table * | join type=left user_id index_prefix
          [ search index=$index_prefix$container
          | rex field=index "(?&lt;index_prefix&gt;[\S]*_*phantom_)container$"
          | dedup index owner | table index index_prefix owner owner_name
          | rename owner as user_id owner_name as username]
      | eval user_id_name = case(user_id=="null", "None (unassigned)", isnull(username), user_id, isnotnull(username), user_id." (".username.")")
    </query>
  </search>
  <row depends="$displayError$,$cloud$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or sc_admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <row depends="$displayError$,$enterprise$">
    <html>
      <div>
        ERROR: At least one of the following roles is required to view this page: splunk_app_soar, splunk_app_soar_dashboards, or admin. Contact your Splunk administrator for access.
      </div>
    </html>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Action Execution Over Time</title>
      <chart>
        <search base="actionRunBaseSearch">
          <query>| search user_id_name="$user_id_name$"  |  eval start = strptime(create_time,"%Y-%m-%dT%H:%M:%S")| eval end = strptime(close_time,"%Y-%m-%dT%H:%M:%S") | eval duration= end -start | timechart span=1h count eval(round(avg(duration),2)) as execution_time by status</query>
        </search>
        <option name="charting.axisLabelsY.integerUnits">true</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.axisTitleY2.text">Execution Time (secs)</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">1</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.overlayFields">"execution_time: failed","execution_time: success"</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Most Active Analysts</title>
      <chart>
        <search base="actionRunBaseSearch">
          <query>| search user_id_name="$user_id_name$" | stats count by index_prefix user_id_name | sort - count | eval index_prefix=index_prefix."*" | chart list(count) by user_id_name, index_prefix | rename count as "Execution Count" user_id_name as "User ID (Username)" | head 10</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel>
      <title>Most Active Actions</title>
      <chart>
        <search base="actionRunBaseSearch">
          <query>| search user_id_name="$user_id_name$" | chart count over action by status | addtotals fieldname=temp_sort |  sort - temp_sort  | fields - temp_sort | head 10</query>
        </search>
        <option name="charting.axisLabelsY.integerUnits">true</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel>
      <title>Action Run by Status</title>
      <chart>
        <search base="actionRunBaseSearch">
          <query>| search user_id_name="$user_id_name$" | stats count by status</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
  </row>
  <row depends="$displayContent$">
    <panel>
      <title>Actions with Highest Failure by Asset</title>
      <chart>
        <search base="appRunBaseSearch">
          <query>| search user_id_name="$user_id_name$" |  rex field=message "on asset '(?&lt;asset_name&gt;[^']+)'" |  stats count by asset_name, action, index_prefix | sort - count | head 10 | eval asset_index = asset_name."(".index_prefix."*)" | chart list(count) by action, asset_index </query>
        </search>
        <option name="charting.axisLabelsY.integerUnits">true</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisTitleY.text">Execution Count</option>
        <option name="charting.axisX.abbreviation">none</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.axisY2.abbreviation">none</option>
        <option name="charting.axisY2.enabled">0</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.layout.splitSeries.allowIndependentYRanges">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.legend.mode">standard</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </chart>
    </panel>
    <panel>
      <title>Action Run Count by Status </title>
      <table>
        <search base="actionRunBaseSearch">
          <query>|  search user_id_name="$user_id_name$" | chart count over action by status  | addtotals fieldname=temp_sort |  sort - temp_sort  | fields - temp_sort</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>
